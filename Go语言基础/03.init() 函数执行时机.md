# init() 函数的基本特性

- 定义方式：init() 函数没有参数，也没有返回值。它可以定义在包中的任何源文件中，甚至一个包可以有多个 init() 函数。
- 执行次数：每个 init() 函数只执行一次，即使包被多次导入。
- 与 main() 的关系：init() 函数在 main() 函数执行之前运行，但不是立即执行，而是按照特定的初始化顺序。

# 先导示例

当前文件目录结构

```go
├─pkg1
└─pkg2
main.go
```

`pkg1/pkg1.go` 代码：

```go
package pkg1

import "fmt"

func init() {
    fmt.Println("pkg1 init")
}
```

`pkg2/pkg2.go` 代码：

```go
package pkg2

import (
    "fmt"
    _ "github.com/namelyzz/go_study/01_basics/003_init_order/pkg1"
)

func init() {
    fmt.Println("pkg2 init")
}
main.go
package main

import (
    "fmt"
    _ "github.com/namelyzz/go_study/01_basics/003_init_order/pkg2"
)

func init() {
    fmt.Println("main init")
}

func main() {
    fmt.Println("main function")
}
```

执行结构：

```go
pkg1 init
pkg2 init
main init
main function
```

pkg1 无依赖，先 init；pkg2 依赖 pkg1，所以次之；main 依赖 pkg2，最后 init，然后进入 main()。

# init() 函数的执行时机

Go 程序的初始化过程是高度自动化的，init() 函数的执行时机遵循以下规则：

1. 包级变量初始化优先：

   - 在执行 init() 之前，Go 会先初始化包中的所有常量和变量（包括全局变量和包级变量）。变量的初始化按声明顺序进行，如果有依赖，则按依赖拓扑顺序。
   - 示例：如果变量 A 依赖变量 B，则 B 先初始化。
   
2. init() 函数的执行：

   - 何时触发：当包被导入（import）时，init() 函数就会被自动调用。这包括：

     - 直接在 main 包中导入其他包。
  - 通过依赖链间接导入（例如，包 A 导入包 B，包 B 有 init()）。
     
- 执行顺序：
   
     - **依赖顺序**：Go 会从最底层的依赖包开始初始化。也就是说，先初始化没有依赖的包，然后是依赖它们的包，以此类推，直到 main 包。
  - **同一包内多个 init()**：如果一个包有多个 init() 函数，它们按源文件的编译顺序（通常是文件名的字母顺序）执行。但更准确地说，是按文件在包中的出现顺序（Go 工具会按文件名排序）。
     - **源文件内**：如果一个源文件中有多个 init()，它们按在文件中的声明顺序执行。
  
   - **全局唯一**：即使包被多个地方导入，init() 只执行一次（Go 运行时会跟踪）。

3. 相对于 main() 的时机：

   - 所有导入包的 init() 函数执行完毕后，才会进入 main() 函数。
   - 如果程序没有 main()（如库包），init() 仍然会在包被加载时执行。
   
4. 特殊场景：

   - **测试时**：在运行 go test 时，测试包的 init() 也会执行。
   - **并发安全**：init() 函数是串行执行的，不存在并发问题。
   - **错误处理**：init() 中如果 panic，会导致程序崩溃，因为它在 main() 之前。

> 面试用，大概 30s 的口述版本： 在 Go 里，init() 会在 main() 之前执行，具体顺序是：先初始化包级常量和变量，然后执行 init()。导入包时，**Go 会从最底层依赖开始往上执行 init()，同一包内多个 init() 会按文件名顺序、再按函数声明顺序执行。**一个包的 init() 不管被多少地方导入，只会执行一次。所有包的 init() 执行完才进入 main()，测试时 go test 也会先跑 init()。init() 函数是串行的，所以不用担心并发问题，但是如果 init() 里面 panic 会直接让程序崩溃。
>
> 核心是突出“变量优先”、“导入触发”、“依赖顺序”、“同包顺序”、“**`main`**之前”、“只执行一次”这几个关键概念。

# 使用 init() 的注意事项与最佳实践

在实际开发中，要避免向 init() 函数中添加复杂逻辑，init() 函数更适合轻量级的初始化任务，比如设置全局变量或注册处理函数。它不应该承载耗时操作或执行 I/O，因为这些都会直接拖慢程序的启动速度。也不要滥用 init() 函数，因为它会降低代码可读性和可测试性。

如果包被 `import _`（匿名导入），只会执行它的 `init()` 和变量初始化，不会导出符号。

调试时，你可以在 init() 中加入 `fmt.Println` 或日志记录，这样能直观地追踪多个包之间的初始化顺序，尤其是在依赖关系复杂的项目中。

需要注意的是，变量初始化和 init() 执行顺序略有不同——全局变量的初始化表达式（例如 var x = someFunc()）会在 init() 之前运行，而 init() 则能提供更灵活的逻辑处理能力。